<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Departure Board</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }

      /* Smooth fade in for rows */
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Pulsing effect for "NOW" departures */
      .pulse-dot {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse-red 2s infinite;
      }

      @keyframes pulse-red {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center py-10 px-4">

<div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-700">

    <div class="bg-gray-800 p-6 border-b border-gray-700 flex justify-between items-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>

        <div>
            <h1 class="text-2xl font-bold tracking-tight text-white flex items-center gap-2">
                <i class="ph ph-bus text-blue-400"></i> Departures
            </h1>
            <p class="text-gray-400 text-sm mt-1" id="current-station">Fetching stop details...</p>
        </div>
        <div class="text-right">
            <div class="text-3xl font-mono font-semibold tracking-widest" id="clock">00:00</div>
            <div class="text-xs text-gray-500 flex items-center justify-end gap-1 mt-1">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-500"></span>
                <span id="last-updated">Waiting for data...</span>
            </div>
        </div>
    </div>

    <div id="board-content" class="divide-y divide-gray-700/50">
        <div class="p-8 text-center text-gray-500 animate-pulse">
            Loading schedule...
        </div>
    </div>
</div>

<p class="mt-6 text-gray-600 text-sm">Updates automatically every 60 seconds</p>

<script>
  const LOCALE = 'pl-PL';
  const API_BASE_PATH = '/api/schedule';
  const REFRESH_RATE = 61000;

  const boardContent = document.getElementById('board-content');
  const lastUpdatedEl = document.getElementById('last-updated');
  const statusDot = document.getElementById('status-dot');
  const clockEl = document.getElementById('clock');
  const currentStationEl = document.getElementById('current-station');


  function getAPIUrl() {
    const params = new URLSearchParams(window.location.search);

    const stopId = params.get('stop_id')
    const stopNumber = params.get('stop_number');
    const lines = params.get('lines');

    if (!stopId || !stopNumber || !lines) {
      const errorMessage = 'Error: Missing URL parameter "stop_id", "stop_number", or "lines".';
      boardContent.innerHTML = `<div class="p-8 text-center text-red-400 font-bold">${errorMessage}</div>`;
      throw new Error(errorMessage);
    }

    let url = `${API_BASE_PATH}/${stopId}/${stopNumber}?lines=${lines}`;

    currentStationEl.textContent = `Stop ID: ${stopId}`;

    return url;
  }

  async function fetchDepartures() {
    try {
      const API_URL = getAPIUrl();

      statusDot.className = 'w-2 h-2 rounded-full bg-yellow-400 animate-ping';

      const response = await fetch(API_URL);

      if (!response.ok) throw new Error('Network response was not ok or API returned an error.');

      const data = await response.json();
      renderBoard(data);

      statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
      const date = new Date(data.updated_at);
      lastUpdatedEl.textContent = `Updated: ${date.toLocaleTimeString(LOCALE)}`;

    } catch (error) {
      console.error('Fetch error:', error);
      statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
      lastUpdatedEl.textContent = 'Connection Error';
    }
  }

  function renderBoard(data) {
    boardContent.innerHTML = '';
    if (data.departures.length === 0) {
      boardContent.innerHTML = '<div class="p-6 text-center text-gray-500">No upcoming departures</div>';
      return;
    }

    data.departures.forEach((dep, index) => {
      const timeDisplay = dep.time_to_depart === 0 ? 'NOW' : `${dep.time_to_depart} min`;

      let badgeColor = 'bg-gray-700 text-gray-300';
      if (dep.time_to_depart === 0) {
        badgeColor = 'bg-red-500/20 text-red-400 border border-red-500/30 pulse-dot';
      } else if (dep.time_to_depart < 5) badgeColor = 'bg-green-500/20 text-green-400 border border-green-500/30';

      const row = document.createElement('div');
      row.className = `p-4 hover:bg-gray-700/30 transition-colors flex items-center justify-between fade-in`;
      row.style.animationDelay = `${index * 50}ms`;

      row.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="h-12 w-12 flex items-center justify-center bg-gray-700 rounded-lg text-xl font-bold text-white shadow-inner border border-gray-600">
                            ${dep.line}
                        </div>

                        <div>
                            <div class="text-lg font-semibold text-white tracking-wide">${dep.direction}</div>
                            <div class="text-sm text-gray-400 flex items-center gap-1">
                                <i class="ph-fill ph-clock"></i> Scheduled: ${dep.time}
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-end">
                        <span class="px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wider ${badgeColor}">
                            ${timeDisplay}
                        </span>
                    </div>
                `;
      boardContent.appendChild(row);
    });
  }

  function updateClock() {
    const now = new Date();
    clockEl.textContent = now.toLocaleTimeString(LOCALE, { hour: '2-digit', minute: '2-digit' });
  }

  updateClock();
  setInterval(updateClock, 1000);

  try {
    fetchDepartures();
    setInterval(fetchDepartures, REFRESH_RATE);
  } catch (e) {
    console.warn(e.message);
  }
</script>
</body>
</html>